name: JSDoc Analysis Comment

on:
  workflow_run:
    workflows: ["Check"]
    types:
      - completed

permissions: {}

jobs:
  pr-comment:
    name: JSDoc Analysis PR
    if: github.event.workflow_run.event == 'pull_request' && github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      actions: read
      pull-requests: write

    timeout-minutes: 2
    steps:
      - name: Debug workflow run
        run: |
          echo "Workflow run event: ${{ github.event.workflow_run.event }}"
          echo "Workflow run conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Workflow run ID: ${{ github.event.workflow_run.id }}"
          echo "PR number: ${{ github.event.workflow_run.pull_requests[0].number }}"
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          name: jsdoc-stats
        continue-on-error: true
      - name: List downloaded files
        run: ls -la
      - name: Get JSDoc stats
        id: stats
        run: |
          if [ -f jsdoc-stats.md ]; then
            echo "Found jsdoc-stats.md file"
            {
              echo 'stats<<EOF'
              cat jsdoc-stats.md
              echo EOF
            } >> $GITHUB_OUTPUT
          else
            echo "jsdoc-stats.md file not found"
            echo "stats=JSDoc analysis artifact not found" >> $GITHUB_OUTPUT
          fi
      - name: Find Comment
        id: find-comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.workflow_run.pull_requests[0].number }}
          comment-author: "github-actions[bot]"
          body-includes: <!-- JSDoc Analysis PR Report -->
      - name: Create or Update PR Comment
        id: comment
        uses: peter-evans/create-or-update-comment@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JSDOC_STATS: "${{ steps.stats.outputs.stats }}"
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.workflow_run.pull_requests[0].number }}
          edit-mode: ${{ steps.find-comment.outputs.comment-id && 'replace' || '' }}
          body: |
            <!-- JSDoc Analysis PR Report -->
            ## ðŸ“Š JSDoc Documentation Analysis

            <details>
            <summary>ðŸ“ˆ Current Analysis Results</summary>

            ${{ env.JSDOC_STATS }}

            </details>

            ---
            *This comment is automatically updated on each push. View the [analysis script](https://github.com/Effect-TS/effect-smol/blob/main/scripts/analyze-jsdoc.mjs) for details.*