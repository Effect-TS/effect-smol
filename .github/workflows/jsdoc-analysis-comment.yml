name: JSDoc Analysis Comment

on:
  workflow_run:
    workflows: ["Check"]
    types:
      - completed

permissions: {}

jobs:
  pr-comment:
    name: JSDoc Analysis PR
    if: github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      actions: read
      pull-requests: write

    timeout-minutes: 2
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          name: jsdoc-stats
      - name: Get JSDoc stats
        id: stats
        run: |
          if [ -f jsdoc-stats.md ]; then
            {
              echo 'stats<<EOF'
              cat jsdoc-stats.md
              echo EOF
            } >> $GITHUB_OUTPUT
          else
            echo "stats=JSDoc analysis artifact not found" >> $GITHUB_OUTPUT
          fi
      - name: Find Comment
        id: find-comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.workflow_run.pull_requests[0].number }}
          comment-author: "github-actions[bot]"
          body-includes: <!-- JSDoc Analysis PR Report -->
      - name: Create or Update PR Comment
        id: comment
        uses: peter-evans/create-or-update-comment@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JSDOC_STATS: "${{ steps.stats.outputs.stats }}"
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.workflow_run.pull_requests[0].number }}
          edit-mode: replace
          body: |
            <!-- JSDoc Analysis PR Report -->
            ## ðŸ“Š JSDoc Documentation Analysis

            <details>
            <summary>ðŸ“ˆ Current Analysis Results</summary>

            ${{ env.JSDOC_STATS }}

            </details>

            ---
            *This comment is automatically updated on each push. View the [analysis script](https://github.com/Effect-TS/effect-smol/blob/main/scripts/analyze-jsdoc.mjs) for details.*

  issue-comment:
    name: JSDoc Analysis Issue
    if: github.event.workflow_run.event == 'push' && github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    permissions:
      actions: read
      issues: write

    timeout-minutes: 2
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          name: jsdoc-stats
      - name: Get JSDoc stats
        id: stats
        run: |
          if [ -f jsdoc-stats.md ]; then
            {
              echo 'stats<<EOF'
              cat jsdoc-stats.md
              echo EOF
            } >> $GITHUB_OUTPUT
          else
            echo "stats=JSDoc analysis artifact not found" >> $GITHUB_OUTPUT
          fi
      - name: Find Comment
        id: find-comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: 219
          comment-author: "github-actions[bot]"
          body-includes: <!-- JSDoc Analysis Report -->
      - name: Create or Update Issue Comment
        id: comment
        uses: peter-evans/create-or-update-comment@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JSDOC_STATS: "${{ steps.stats.outputs.stats }}"
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: 219
          edit-mode: replace
          body: |
            <!-- JSDoc Analysis Report -->
            # ðŸ“Š JSDoc Documentation Analysis Report

            **Last Updated:** ${{ github.event.workflow_run.updated_at }}  
            **Commit:** ${{ github.event.workflow_run.head_sha }}

            <details>
            <summary>ðŸ“ˆ Latest Analysis Results</summary>

            ${{ env.JSDOC_STATS }}

            </details>

            ---
            *This comment is automatically updated when changes are pushed to main. View the [analysis script](https://github.com/Effect-TS/effect-smol/blob/main/scripts/analyze-jsdoc.mjs) for details.*